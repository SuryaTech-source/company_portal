<div class="salary-list-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page_title">Salary List</h2>
        <div>
            <button class="btn btn-danger mr-2" (click)="openPenaltyModal(penaltyTemplate)">
                <i class="fa fa-exclamation-triangle"></i> Add Penalty
            </button>
            <button class="btn btn-success" (click)="openAllowanceModal(allowanceTemplate)">
                <i class="fa fa-money"></i> Add Allowance
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4 align-items-end">
        <div class="col-md-3">
            <label>Year</label>
            <select class="form-select" [(ngModel)]="selectedYear" (change)="onFilterChange()">
                <option *ngFor="let year of years" [value]="year">{{ year }}</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>Month</label>
            <select class="form-select" [(ngModel)]="selectedMonth" (change)="onFilterChange()">
                <option *ngFor="let month of months" [value]="month.value">{{ month.name }}</option>
            </select>
        </div>
        <div class="col-md-4">
            <label>Search Employee</label>
            <input type="text" class="form-control" placeholder="Name or ID" [(ngModel)]="searchQuery"
                (keyup.enter)="onFilterChange()">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" (click)="onFilterChange()">Search</button>
        </div>
    </div>

    <div class="d-flex justify-content-end mb-3">
        <button class="export_btn" (click)="downloadPDF()">
            Download PDF
        </button>
    </div>

    <!-- Table -->
    <div id="salaryTable" class="table_section">
        <table class="table table-bordered table-striped text-center">
            <thead class="table-dark">
                <tr>
                    <th class="sortable" (click)="sort('employeeName')">
                        Employee Name
                        <span *ngIf="sortBy === 'employeeName'">{{ sortOrder === 1 ? '▲' : '▼' }}</span>
                    </th>
                    <th class="sortable" (click)="sort('employeeId')">
                        Employee ID
                        <span *ngIf="sortBy === 'employeeId'">{{ sortOrder === 1 ? '▲' : '▼' }}</span>
                    </th>
                    <th>Month/Year</th>
                    <th>Base Salary</th>
                    <th class="sortable" (click)="sort('daysPresent')">
                        Days Present
                        <span *ngIf="sortBy === 'daysPresent'">{{ sortOrder === 1 ? '▲' : '▼' }}</span>
                    </th>
                    <th class="sortable" (click)="sort('overtime')">
                        Overtime
                        <span *ngIf="sortBy === 'overtime'">{{ sortOrder === 1 ? '▲' : '▼' }}</span>
                    </th>
                    <th>Total Deductions</th>
                    <th class="sortable" (click)="sort('salary')">
                        Total Payout
                        <span *ngIf="sortBy === 'salary'">{{ sortOrder === 1 ? '▲' : '▼' }}</span>
                    </th>
                    <th class="sortable" (click)="sort('status')">
                        Status
                        <span *ngIf="sortBy === 'status'">{{ sortOrder === 1 ? '▲' : '▼' }}</span>
                    </th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let salary of salaries">
                    <td>{{ salary.employeeDetails?.fullName }}</td>
                    <td>{{ salary.employeeDetails?.employeeId }}</td>
                    <td>{{ salary.month }}/{{ salary.year }}</td>
                    <td>{{ salary.baseSalary | currency: currency_code: currency_symbol }}</td>
                    <td>{{ salary.daysPresent }}</td>
                    <td>{{ salary.overtimeAmount | currency: currency_code: currency_symbol }}</td>
                    <td>{{ salary.totalPenaltyAmount | currency: currency_code: currency_symbol }}</td>
                    <td class="fw-bold">{{ salary.finalSalary | currency: currency_code: currency_symbol }}</td>
                    <td>
                        <span class="badge" [ngClass]="{
                          'bg-success': salary.paymentStatus === 'Paid',
                          'bg-warning': salary.paymentStatus === 'Pending',
                          'bg-danger': salary.paymentStatus === 'Failed'
                      }">
                            {{ salary.paymentStatus }}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" (click)="viewSalary(salary.employee)">
                            View Salary
                        </button>
                    </td>
                </tr>
                <tr *ngIf="salaries.length === 0">
                    <td colspan="10">No salary records found for the selected criteria.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div *ngIf="loading" class="text-center mt-4">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
    </div>
</div>

<!-- Penalty Modal -->
<ng-template #penaltyTemplate>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Add Driver Penalty</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div class="form-group mb-3">
            <label>Vehicle <span class="text-danger">*</span></label>
            <ng-select [items]="fleets" bindLabel="vehicleName" bindValue="_id" [(ngModel)]="penaltyData.fleetId"
                (change)="onPenaltyDetailsChange()" placeholder="Select Vehicle">

                <ng-template ng-option-tmp let-item="item">
                    {{item.vehicleName}} ({{item.registrationNo}})
                </ng-template>
            </ng-select>
        </div>
        <div class="form-group mb-3">
            <label>Penalty Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control" [ngModel]="penaltyData.date | date:'yyyy-MM-dd'"
                (ngModelChange)="penaltyData.date = $event; onPenaltyDetailsChange()">
        </div>

        <div class="form-group mb-3">
            <label>Driver (Auto-Selected)</label>
            <input type="text" class="form-control" [value]="penaltyData.driverName" readonly>
            <small *ngIf="loadingDriver" class="text-muted">Fetching driver...</small>
        </div>

        <div class="form-group mb-3">
            <label>Penalty Amount <span class="text-danger">*</span></label>
            <input type="number" class="form-control" [(ngModel)]="penaltyData.amount">
        </div>

        <div class="form-group mb-3">
            <label>Penalty Type <span class="text-danger">*</span></label>
            <select class="form-control" [(ngModel)]="penaltyData.type">
                <option value="Speed Violations">Speed Violations</option>
                <option value="Accidents">Accidents</option>
                <option value="Traffic Penalties">Traffic Penalties</option>
                <option value="Incidents">Incidents</option>
                <option value="Other">Others</option>
            </select>
        </div>

        <div class="form-group mb-3">
            <label>Reason</label>
            <textarea class="form-control" rows="2" [(ngModel)]="penaltyData.reason"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modalRef.hide()">Close</button>
        <button type="button" class="btn btn-danger" [disabled]="!penaltyData.driverId" (click)="savePenalty()">Record
            Penalty</button>
    </div>
</ng-template>

<!-- Allowance Modal -->
<ng-template #allowanceTemplate>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Add Employee Allowance/Advance</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div class="form-group mb-3">
            <label>Employee <span class="text-danger">*</span></label>
            <ng-select [items]="employees" bindLabel="fullName" bindValue="_id" [(ngModel)]="allowanceData.employeeId"
                placeholder="Search Employee">
                <ng-template ng-option-tmp let-item="item">
                    {{item.fullName}} ({{item.employeeId}})
                </ng-template>
            </ng-select>
        </div>
        <div class="form-group mb-3">
            <label>Date Given <span class="text-danger">*</span></label>
            <input type="date" class="form-control" [ngModel]="allowanceData.date | date:'yyyy-MM-dd'"
                (ngModelChange)="allowanceData.date = $event">
        </div>
        <div class="form-group mb-3">
            <label>Amount <span class="text-danger">*</span></label>
            <input type="number" class="form-control" [(ngModel)]="allowanceData.amount">
        </div>
        <div class="form-group mb-3">
            <label>Notes</label>
            <textarea class="form-control" rows="2" [(ngModel)]="allowanceData.notes"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modalRef.hide()">Close</button>
        <button type="button" class="btn btn-primary" (click)="saveAllowance()">Record Allowance</button>
    </div>
</ng-template>