<div class="feet-assignment_page">
  <h2 class="page_title">Fleet Assignment Report</h2>
  <div class="row text-center mb-4">
    <div class="col-md-4 mb-3 card_sec" *ngFor="let card of [
        { title: 'Total No. of Vehicles', value: totalVehicles },
        { title: 'Deployed Vehicles', value: deployedVehicles },
        { title: 'Vehicles on Maintenance Schedule', value: vehiclesOnMaintenance }
      ]">
      <div class="card-body">
        <h5>{{ card.title }}</h5>
        <h2>{{ card.value }}</h2>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <input class="form-control w-25" placeholder="Search..." [(ngModel)]="search"
      (keyup.enter)="loadFleetAssignments()">
    <div class="d-flex gap-10">
      <button class="btn btn-success me-2" (click)="openAssignModal()">+ Add Assignment</button>
      <button class="export_btn" (click)="downloadPDF()">
        <span class="folderContainer">
          <svg class="fileBack" width="146" height="113" viewBox="0 0 146 113" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M0 4C0 1.79086 1.79086 0 4 0H50.3802C51.8285 0 53.2056 0.627965 54.1553 1.72142L64.3303 13.4371C65.2799 14.5306 66.657 15.1585 68.1053 15.1585H141.509C143.718 15.1585 145.509 16.9494 145.509 19.1585V109C145.509 111.209 143.718 113 141.509 113H3.99999C1.79085 113 0 111.209 0 109V4Z"
              fill="url(#paint0_linear_117_4)"></path>
            <defs>
              <linearGradient id="paint0_linear_117_4" x1="0" y1="0" x2="72.93" y2="95.4804"
                gradientUnits="userSpaceOnUse">
                <stop stop-color="#8F88C2"></stop>
                <stop offset="1" stop-color="#5C52A2"></stop>
              </linearGradient>
            </defs>
          </svg>
          <svg class="filePage" width="88" height="99" viewBox="0 0 88 99" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <rect width="88" height="99" fill="url(#paint0_linear_117_6)"></rect>
            <defs>
              <linearGradient id="paint0_linear_117_6" x1="0" y1="0" x2="81" y2="160.5" gradientUnits="userSpaceOnUse">
                <stop stop-color="white"></stop>
                <stop offset="1" stop-color="#686868"></stop>
              </linearGradient>
            </defs>
          </svg>

          <svg class="fileFront" width="160" height="79" viewBox="0 0 160 79" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M0.29306 12.2478C0.133905 9.38186 2.41499 6.97059 5.28537 6.97059H30.419H58.1902C59.5751 6.97059 60.9288 6.55982 62.0802 5.79025L68.977 1.18034C70.1283 0.410771 71.482 0 72.8669 0H77H155.462C157.87 0 159.733 2.1129 159.43 4.50232L150.443 75.5023C150.19 77.5013 148.489 79 146.474 79H7.78403C5.66106 79 3.9079 77.3415 3.79019 75.2218L0.29306 12.2478Z"
              fill="url(#paint0_linear_117_5)"></path>
            <defs>
              <linearGradient id="paint0_linear_117_5" x1="38.7619" y1="8.71323" x2="66.9106" y2="82.8317"
                gradientUnits="userSpaceOnUse">
                <stop stop-color="#C3BBFF"></stop>
                <stop offset="1" stop-color="#51469A"></stop>
              </linearGradient>
            </defs>
          </svg>
        </span>
        <p class="text">Download as PDF</p>
      </button>
    </div>
  </div>

  <!-- Table -->
  <div id="pdfContent" class="table_section">
    <table class="table table-bordered table-striped text-center">
      <thead class="table-dark">
        <tr>
          <th>Vehicle No & Name</th>
          <th>Asset Code</th>
          <th>Assigned To</th>
          <th>Date Assigned</th>
          <th>Odometer Start</th>
          <th>Contract ID</th>
          <th>Remarks</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let fleet of fleets">
          <td>{{ fleet.registrationNo }} - {{ fleet.vehicleName }}</td>
          <td>{{ fleet.assetCode }}</td>
          <td>{{ fleet.assignedTo }}</td>
          <td>{{ fleet.dateAssigned | date: 'dd/MM/yyyy' }}</td>
          <td>{{ fleet.odometerReadingStart || '-' }}</td>
          <td>{{ fleet.contractId || '-' }}</td>
          <td>{{ fleet.remarks || '-' }}</td>
          <td>
            <span class="badge" [ngClass]="fleet.status == 1 ? 'bg-success' : 'bg-secondary'">
              {{ fleet.status == 1 ? 'Active' : 'Completed' }}
            </span>
          </td>
          <td>
            <button *ngIf="fleet.status == 1" class="btn btn-sm btn-danger" (click)="openUnassignModal(fleet)">
              Unassign
            </button>
          </td>
        </tr>
        <tr *ngIf="fleets.length === 0">
          <td colspan="9">No assignments found</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ✅ Assign Modal -->
<div class="modal fade show" tabindex="-1" [ngClass]="{ 'd-block': showAssignModal }" *ngIf="showAssignModal">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <form (ngSubmit)="saveAssignment()">
        <div class="modal-header">
          <h5 class="modal-title">Assign Fleet to Driver</h5>
          <button type="button" class="btn-close" (click)="showAssignModal = false"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-12">
              <div class="label_input">
                <label>Fleet</label>
                <select class="form-select" [(ngModel)]="assignForm.fleetId" name="fleetId" required>
                  <option value="">Select Fleet</option>
                  <option *ngFor="let f of fleetOptions" [value]="f._id">
                    {{ f.registrationNo }} - {{ f.vehicleName }}
                  </option>
                </select>
              </div>
            </div>
            <div class="col-12">
              <div class="label_input">
                <label>Driver</label>
                <select class="form-select" [(ngModel)]="assignForm.driverId" name="driverId" required>
                  <option value="">Select Driver</option>
                  <option *ngFor="let d of drivers" [value]="d._id">{{ d.fullName }}</option>
                </select>
              </div>
            </div>
            <div class="col-12">
              <div class="label_input">
                <label>Date Assigned</label>
                <input type="date" class="form-control" [(ngModel)]="assignForm.dateAssigned" name="dateAssigned">
              </div>
            </div>
            <div class="col-12">
              <div class="label_input">
                <label>Odometer Reading</label>
                <input type="number" class="form-control" [(ngModel)]="assignForm.odometerReadingStart"
                  name="odometerReadingStart">
              </div>
            </div>
            <div class="col-12">
              <div class="label_input">
                <label>Contract ID</label>
                <input type="text" class="form-control" [(ngModel)]="assignForm.contractId" name="contractId">
              </div>
            </div>
            <div class="col-12">
              <div class="label_input">
                <label>Remarks</label>
                <textarea class="form-control" [(ngModel)]="assignForm.remarks" name="remarks"></textarea>
              </div>
            </div>
          </div>
          <div class="page_footer">
            <button type="button" class="close_btn" (click)="showAssignModal = false">Cancel</button>
            <button type="submit" class=" bg_green"> Assign
              <div class="icon">
                <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"
                    fill="currentColor"></path>
                </svg>
              </div>
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- ✅ Unassign Modal -->
<div class="modal fade show" tabindex="-1" [ngClass]="{ 'd-block': showUnassignModal }" *ngIf="showUnassignModal">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <form (ngSubmit)="unassignFleet()">
        <div class="modal-header">
          <h5 class="modal-title">Unassign Fleet</h5>
          <button type="button" class="btn-close" (click)="showUnassignModal = false"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-12">
              <div class="label_input">
                <label>Odometer End Reading</label>
                <input type="number" class="form-control" [(ngModel)]="unassignForm.odometerReadingEnd"
                  name="odometerReadingEnd" required>
              </div>
            </div>
            <div class="col-12">
              <div class="label_input">
                <label>Remarks</label>
                <textarea class="form-control" [(ngModel)]="unassignForm.remarks" name="remarks"></textarea>
              </div>
            </div>
          </div>
          <div class="page_footer">
            <button type="button" class="close_btn" (click)="showUnassignModal = false">Cancel</button>
            <button type="submit" class=" bg_green"> Unassign
              <div class="icon">
                <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"
                    fill="currentColor"></path>
                </svg>
              </div>
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>