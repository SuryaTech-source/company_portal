<form class="row" #tagForm="ngForm" (ngSubmit)="onFormSubmit(tagForm)" autocomplete="off">

  <div class="col-md-4">
    <div class="label_input">
      <label>Carrier Name <span class="mandatory">*</span></label>
      <input type="text" class="form-control" name="carrierName"
             [(ngModel)]="userDetails.carrierName" required maxlength="30">
    </div>
  </div>

  <div class="col-md-4">
    <div class="label_input">
      <label>No. of Buses <span class="mandatory">*</span></label>
      <input type="number" class="form-control" name="noOfBuses"
             [(ngModel)]="form.noOfBuses" (change)="generateFleetDriverRows()" min="1" required>
    </div>
  </div>

  <div class="col-md-4">
    <div class="label_input">
      <label>Contract <span class="mandatory">*</span></label>
      <select class="form-control" name="contractId" [(ngModel)]="userDetails.contractId" required>
        <option value="">Select Contract</option>
        <option *ngFor="let c of contracts" [value]="c._id">
          {{ c.contractId }} - {{ c.clientName }}
        </option>
      </select>
    </div>
  </div>

  <div class="col-md-4">
    <div class="label_input">
      <label>Contract Type <span class="mandatory">*</span></label>
      <select class="form-control" name="contractType" [(ngModel)]="userDetails.contractType" required>
        <option value="">Select Type</option>
        <option *ngFor="let type of contractTypes" [value]="type">{{ type }}</option>
      </select>
    </div>
  </div>

  <div class="col-md-4">
    <div class="label_input">
      <label>Start Date <span class="mandatory">*</span></label>
      <input type="date" class="form-control" name="startDate" [(ngModel)]="userDetails.startDate" required>
    </div>
  </div>

  <div class="col-md-4">
    <div class="label_input">
      <label>End Date <span class="mandatory">*</span></label>
      <input type="date" class="form-control" name="endDate" [(ngModel)]="userDetails.endDate" required>
    </div>
  </div>

  <h5 class="col-12 mt-3" *ngIf="form.noOfBuses > 0">Assign Buses & Drivers</h5>

  <table class="table table-bordered" *ngIf="form.noOfBuses > 0">
    <thead>
      <tr>
        <th>Bus Register Number</th>
        <th>Driver Name</th>
        <th>Driver Contact</th>
        <th>Driver Document</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of assignedFleetDrivers; let i = index;">
        <td>
          <select class="form-control" [(ngModel)]="row.busId" name="bus{{i}}" required>
            <option value="">Select Bus</option>
            <option *ngFor="let f of fleets" [value]="f._id">{{ f.registrationNo }}</option>
          </select>
        </td>

        <td>
          <select class="form-control" [(ngModel)]="row.driverId" name="driver{{i}}" (change)="onDriverSelect(i)" required>
            <option value="">Select Driver</option>
            <option *ngFor="let d of drivers" [value]="d._id">{{ d.fullName }}</option>
          </select>
        </td>

        <td>
          <input type="text" class="form-control" [(ngModel)]="row.contactNumber" name="contact{{i}}" readonly>
        </td>

        <td>
  <div class="d-flex gap-2 align-items-center">
    <input type="file" class="form-control" (change)="uploadDriverDoc($event, i)">
    <!-- Server-hosted preview -->
    <button
      type="button"
      class="btn btn-sm btn-primary"
      *ngIf="assignedFleetDrivers[i]?.driverDocUrl"
      (click)="previewDriverDoc(i)"
    >
      Preview
    </button>
    <!-- Fallback preview for freshly selected file (not yet uploaded) -->
    <button
      type="button"
      class="btn btn-sm btn-secondary"
      *ngIf="!assignedFleetDrivers[i]?.driverDocUrl && assignedFleetDrivers[i]?.driverDocFile"
      (click)="previewDriverDocLocal(i)"
      title="Local preview (not uploaded)"
    >
      Preview
    </button>
  </div>
</td>

      </tr>
    </tbody>
  </table>

  <h5 class="col-12">Documents</h5>

  <div class="col-md-4">
    <label>Upload Document <span class="mandatory">*</span></label>
    <input type="file" class="form-control" (change)="onVendorDocSelect($event)">
  </div>

  <div class="col-md-4">
    <label>Document Type <span class="mandatory">*</span></label>
    <select class="form-control" [(ngModel)]="userDetails.documentType" name="documentType" required>
      <option value="">Select Type</option>
      <option value="PDF">PDF</option>
      <option value="DOC">DOC</option>
    </select>
  </div>

  <div class="col-md-4" *ngIf="userDetails.documentFile">
    <label>Uploaded File:</label>
    <div>
      <button type="button" class="btn btn-sm btn-primary" (click)="previewDoc()">Preview</button>
      <button type="button" class="btn btn-sm btn-success" (click)="downloadDoc()">Download</button>
    </div>
  </div>

  <div class="page_footer">
    <button type="button" routerLink="/app/carrier/list" class="close_btn">Cancel</button>
    <button type="submit" class="bg_green" [disabled]="submitebtn">Save</button>
  </div>
</form>
