<div class="maintenance_record_report_page">
  <div class="title_sec">
    <h5 class="page_title">Maintenance Records Report</h5>
    <div class="d-flex gap-3">
      <button class="btn btn-sm btn-success" (click)="openModal()">
        <i class="bi bi-plus-lg"></i> Add Maintenance
      </button>
      <button class="export_btn" (click)="downloadPDF()">
        <span class="folderContainer">
          <svg class="fileBack" width="146" height="113" viewBox="0 0 146 113" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M0 4C0 1.79086 1.79086 0 4 0H50.3802C51.8285 0 53.2056 0.627965 54.1553 1.72142L64.3303 13.4371C65.2799 14.5306 66.657 15.1585 68.1053 15.1585H141.509C143.718 15.1585 145.509 16.9494 145.509 19.1585V109C145.509 111.209 143.718 113 141.509 113H3.99999C1.79085 113 0 111.209 0 109V4Z"
              fill="url(#paint0_linear_117_4)"></path>
            <defs>
              <linearGradient id="paint0_linear_117_4" x1="0" y1="0" x2="72.93" y2="95.4804"
                gradientUnits="userSpaceOnUse">
                <stop stop-color="#8F88C2"></stop>
                <stop offset="1" stop-color="#5C52A2"></stop>
              </linearGradient>
            </defs>
          </svg>
          <svg class="filePage" width="88" height="99" viewBox="0 0 88 99" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <rect width="88" height="99" fill="url(#paint0_linear_117_6)"></rect>
            <defs>
              <linearGradient id="paint0_linear_117_6" x1="0" y1="0" x2="81" y2="160.5" gradientUnits="userSpaceOnUse">
                <stop stop-color="white"></stop>
                <stop offset="1" stop-color="#686868"></stop>
              </linearGradient>
            </defs>
          </svg>

          <svg class="fileFront" width="160" height="79" viewBox="0 0 160 79" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M0.29306 12.2478C0.133905 9.38186 2.41499 6.97059 5.28537 6.97059H30.419H58.1902C59.5751 6.97059 60.9288 6.55982 62.0802 5.79025L68.977 1.18034C70.1283 0.410771 71.482 0 72.8669 0H77H155.462C157.87 0 159.733 2.1129 159.43 4.50232L150.443 75.5023C150.19 77.5013 148.489 79 146.474 79H7.78403C5.66106 79 3.9079 77.3415 3.79019 75.2218L0.29306 12.2478Z"
              fill="url(#paint0_linear_117_5)"></path>
            <defs>
              <linearGradient id="paint0_linear_117_5" x1="38.7619" y1="8.71323" x2="66.9106" y2="82.8317"
                gradientUnits="userSpaceOnUse">
                <stop stop-color="#C3BBFF"></stop>
                <stop offset="1" stop-color="#51469A"></stop>
              </linearGradient>
            </defs>
          </svg>
        </span>
        <p class="text">Download as PDF</p>
      </button>
    </div>
  </div>
  <div class="d-flex gap-2 align-items-center justify-content-end mb-3">
    <input type="text" placeholder="üöê Vehicle No." [(ngModel)]="searchVehicle" />
    <input type="text" placeholder="üë® Driver" [(ngModel)]="searchDriver" />
    <select [(ngModel)]="filterType">
      <option value="">All Types</option>
      <option value="Repaired">Repaired</option>
      <option value="Serviced">Serviced</option>
      <option value="Replaced">Replaced</option>
    </select>
    <select [(ngModel)]="filterPart">
      <option value="">All Parts</option>
      <option value="Brake Pads">Brake Pads</option>
      <option value="Engine Oil">Engine Oil</option>
      <option value="Front Tyres">Front Tyres</option>
    </select>
    <input type="date" class="date_input" [(ngModel)]="startDate" />
    <input type="date" class="date_input" [(ngModel)]="endDate" />
    <select class="page_filter" [(ngModel)]="sortBy">
      <option value="">Sort ‚¨ç</option>
      <option value="dateAsc">Date ‚Üë</option>
      <option value="dateDesc">Date ‚Üì</option>
      <option value="vehicle">Vehicle</option>
      <option value="driver">Driver</option>
      <option value="costAsc">Cost ‚Üë</option>
      <option value="costDesc">Cost ‚Üì</option>
    </select>
  </div>

  <div #maintenanceTable class="table_section">
    <table class="table table-bordered table-striped custom-table">
      <thead>
        <tr>
          <th>DATE</th>
          <th>VEHICLE NO.</th>
          <th>DRIVER NAME</th>
          <th>MAINTENANCE TYPE</th>
          <th>PARTS REPLACED / SERVICED</th>
          <th>MAINTENANCE COST</th>
          <th>REMARKS</th>
          <th>ACTION</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of filteredRecords">
          <td>{{ row.maintenanceDate | date : "yyyy-MM-dd" }}</td>
          <td>{{ row.vehicleData?.registrationNo }}</td>
          <td>{{ row.driverData?.fullName }}</td>
          <td>{{ row.maintenanceType }}</td>
          <td>
            <span *ngFor="let p of row.partDetails">{{ p.name }} ({{ p.partNumber }})
            </span>
          </td>
          <td>
            {{ row.maintenanceCost | currency : currency_code : currency_symbol : "1.0-2" }}
          </td>
          <td>{{ row.remarks }}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2" (click)="openModal(row)">
              Edit
            </button>
            <button class="btn btn-sm btn-danger" (click)="openDeleteModal(deletePopup, row)">
              Delete
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal fade show" tabindex="-1" [ngClass]="{ 'd-block': showModal }" *ngIf="showModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form (ngSubmit)="saveMaintenance()">
          <div class="modal-header">
            <h5 class="modal-title">
              {{ editData ? "Edit" : "Add" }} Maintenance
            </h5>
            <button type="button" class="btn-close" (click)="closeModal()"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 col-sm-12">
                <div class="label_input">
                  <label class="form-label">Vehicle</label>
                  <select class="form-select" [(ngModel)]="form.vehicle" name="vehicle" required>
                    <option *ngFor="let v of vehicles" [value]="v._id">
                      {{ v.registrationNo }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-6 col-sm-12">
                <div class="label_input">
                  <label class="form-label">Driver</label>
                  <select class="form-select" [(ngModel)]="form.driver" name="driver" required>
                    <option *ngFor="let d of drivers" [value]="d._id">
                      {{ d.fullName }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-6 col-sm-12">
                <div class="label_input">
                  <label class="form-label">Maintenance Type</label>
                  <select class="form-select" [(ngModel)]="form.maintenanceType" name="maintenanceType" required>
                    <option value="Repaired">Repaired</option>
                    <option value="Serviced">Serviced</option>
                    <option value="Replaced">Replaced</option>
                  </select>
                </div>
              </div>
              <!-- <div class="col-md-6 col-sm-12">
                <div class="label_input">
                  <label class="form-label">Cost</label>
                  <input type="number" class="form-control" [(ngModel)]="form.maintenanceCost" name="maintenanceCost"
                    required />
                </div>
              </div> -->
              <!-- Spare Parts Used -->
              <div class="col-12">
                <div class="label_input">
                  <div class="d-flex justify-content-between mb-3">
                    <label class="form-label">Spare Parts Used</label>
                    <button type="button" class="btn btn-outline-primary btn-sm" (click)="addPart()">
                      + Add Part
                    </button>
                  </div>

                  <div class="row mb-2 aic" *ngFor="let p of form.partsUsed; let i = index">
                    <div class="col-md-3">
                      <select class="form-select" [(ngModel)]="p.part" name="part{{ i }}"
                        (change)="updatePartDetails(i)" required>
                        <option value="">Select Part</option>
                        <option *ngFor="let sp of spareParts" [value]="sp._id">
                          {{ sp.name }} ({{ sp.partNumber }})
                        </option>
                      </select>
                    </div>

                    <div class="col-md-2">
                      <input type="number" class="form-control" [(ngModel)]="p.quantity" name="quantity{{ i }}" min="1"
                        (input)="updatePartTotal(i)" />
                    </div>

                    <div class="col-md-2">
                      <input type="number" class="form-control" [(ngModel)]="p.pricePerUnit" name="price{{ i }}" min="0"
                        (input)="updatePartTotal(i)" placeholder="Price" />
                    </div>

                    <div class="col-md-2">
                      <input type="number" class="form-control" [(ngModel)]="p.discount" name="discount{{ i }}" min="0"
                        max="100" (input)="updatePartTotal(i)" placeholder="% Off" />
                    </div>

                    <div class="col-md-2">
                      <input type="number" class="form-control" [(ngModel)]="p.finalPrice" name="finalPrice{{ i }}"
                        readonly [placeholder]="'Final ' + currency_symbol" />
                    </div>

                    <div class="col-md-1 text-center">
                      <button type="button" class="btn btn-sm btn-danger" (click)="removePart(i)">
                        ‚úï
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Extra Charges & Total -->
              <div class="col-md-6 col-sm-12">
                <div class="label_input">
                  <label class="form-label">Extra Charges (if any)</label>
                  <input type="number" class="form-control" [(ngModel)]="form.extraCharges" name="extraCharges"
                    (input)="calculateTotal()" />
                </div>
              </div>

              <div class="col-md-6 col-sm-12">
                <div class="label_input">
                  <label class="form-label">Total Maintenance Cost</label>
                  <input type="number" class="form-control" [(ngModel)]="form.maintenanceCost" name="maintenanceCost"
                    readonly />
                </div>
              </div>

              <div class="col-12">
                <div class="label_input">
                  <label class="form-label">Remarks</label>
                  <textarea class="form-control" [(ngModel)]="form.remarks" name="remarks"></textarea>
                </div>
              </div>
            </div>
            <div class="page_footer">
              <button type="button" class="close_btn" (click)="closeModal()">
                Cancel
              </button>
              <button type="submit" class="bg_green">
                {{ editData ? "Update" : "Save" }}
                <div class="icon">
                  <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"
                      fill="currentColor"></path>
                  </svg>
                </div>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<ng-template #deletePopup>
  <div class="logout_modal">
    <div class="modal-body login-body">
      <div class="h4_close">
        <h4>Delete Maintenance Record</h4>
        <div (click)="closeDeleteModal()" style="cursor: pointer" title="close the popup" class="pop_cls_btn">
          &#10006;
        </div>
      </div>
      <h6 class="modal-title">Are you sure you want to delete this maintenance record?</h6>
      <p class="text-muted small">This action will restore the stock of any spare parts used in this record.</p>
    </div>
    <div class="modal-footer border-0">
      <button type="button" (click)="closeDeleteModal()" class="btn cancel-btn">
        Cancel
      </button>
      <button type="button" (click)="confirmDelete()" class="btn btn-danger">
        Delete
      </button>
    </div>
  </div>
</ng-template>